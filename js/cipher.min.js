/* Copyright (c) 2013 Luigi Cavalieri, http://cavalieri.io - GPL v3.0 */var Cipher=function(e){var t,n,r,i=!0,s={isOpened:!1},o={},u={code:{open:"<code>",close:"</code>",isOpened:!1},pre:{open:"<pre><code>",close:"</code></pre>",isOpened:!1}},a={quot:'"'},f={"<":"lt",">":"gt","&":"amp"},l=function(t){o=t;if(document.selection){o.focus();o.range=document.selection.createRange();o.sel=o.range.text}else o.sel=t.value.substring(t.selectionStart,t.selectionEnd);o.selActive=o.sel!=""},c=function(t,n,o){if(s.isOpened||i)t=t.replace(r,function(e){return"&"+f[e]+";"});n&&(t=u[o].open+t+u[o].close);return t},h=function(t,n){if(t.range){t.focus();t.range.text=n;t.range.moveToBookmark(t.range.getBookmark());t.range.select()}else{var r=t.scrollTop,i=t.selectionStart+n.length;t.value=t.value.substring(0,t.selectionStart)+n+t.value.substring(t.selectionEnd);t.selectionStart=t.selectionEnd=i;t.scrollTop=r}};return{init:function(i){var o="";t=this;s.view=e("#cipher");s.textarea=document.getElementById("cipher-code-area");s.submit=document.getElementById("cipher-submit");s.wrapCheck=document.getElementById("cipher-wrap-checkbox");s.preRadio=document.getElementById("cipher-pre-wrap");s.codeRadio=document.getElementById("cipher-code-wrap");e(document).bind("keydown keyup",t.toggleEnconding);e("#cipher-cancel").bind("click",t.close);e(s.textarea).bind("keydown",t.keyDown);s.view.bind("submit",t.onSubmit);s.view.bind("keyup",t.keyUp);s.view.bind("wpdialogbeforeopen",t.beforeOpen);s.view.bind("wpdialogclose",t.onClose);edButtons.splice(110,1);QTags.addButton("pre","pre+code",t.tag,"","","",109);QTags.addButton("code","code",t.tag,"","c","",110);QTags.addButton("snippet","snippet",t.open,"","",i.qTitle,111);if(pagenow&&(pagenow=="edit-comments"||pagenow=="comment")){f["."]="#46";f["/"]="#47";f["@"]="#64";a["#39"]="'"}for(var u in f){o+=u;a[f[u]]=u}n=i;r=new RegExp("["+o+"]","g")},open:function(e,t){l(t);s.view.data("wpdialog")||s.view.wpdialog({title:n.dialogTitle,width:600,height:"auto",modal:!0,dialogClass:"wp-dialog",zIndex:3e5});s.view.wpdialog("open")},beforeOpen:function(){s.isOpened=!0;s.submit.value=n.submitTitles[Number(o.selActive)];if(!o.selActive)return s.wrapCheck.checked=s.preRadio.checked=!0;s.wrapCheck.checked=!1;var e=o.sel.replace(/^(<pre[^>]*>)?<code[^>]*>([\s\S]*)<\/code>(<\/pre>)?$/,function(e,t,n,r){if(t&&!r||!t&&r)return e;s.wrapCheck.checked=!0;t?s.preRadio.checked=!0:s.codeRadio.checked=!0;return n});s.textarea.value=e.replace(/&[0-9a-z#]{2,4};/g,function(e){e=e.replace("0","");var t=a[e.substr(1,e.length-2)];return t?t:e})},close:function(){s.view.wpdialog("close");return!1},onClose:function(){s.isOpened=!1;s.textarea.value="";o.focus()},onSubmit:function(){if(s.textarea.value){var e=s.preRadio.checked?"pre":"code";h(o,c(s.textarea.value,s.wrapCheck.checked,e));return t.close()}s.textarea.focus();return!1},keyDown:function(t){if(t.which!=e.ui.keyCode.TAB)return!0;if(document.selection){s.textarea.focus();s.textarea.range=document.selection.createRange()}h(s.textarea,"	");return!1},keyUp:function(n){if(n.which!=e.ui.keyCode.ESCAPE)return!0;n.stopImmediatePropagation();return t.close()},toggleEnconding:function(e){e.which==18&&(i=!i);return!0},tag:function(e,t,n){var r,i,s=e.id.substr(n.name.length+1);l(t);if(o.selActive)r=c(o.sel,!0,s);else{if(i=u[s].isOpened){r=u[s].close;e.value=e.value.substring(1)}else{r=u[s].open;e.value="/"+e.value}u[s].isOpened=!i}h(o,r)}}}(jQuery);